From 0000000000000000000000000000000000000000 Mon Sep 17 00:00:00 2001
From: Ghaf Team <ghaf@tii.ae>
Date: Wed, 8 Jan 2025 00:00:00 +0000
Subject: [PATCH] nvmap: Fix register_shrinker API for kernel 6.6

In kernel 6.6, register_shrinker() requires a second argument for
the shrinker name. This patch adds the actual fix to the nvmap code,
not just the conftest.

Signed-off-by: Ghaf Team <ghaf@tii.ae>
---
 nvidia-oot/drivers/video/tegra/nvmap/nvmap_pp.c | 8 ++++++++
 1 file changed, 8 insertions(+)

diff --git a/nvidia-oot/drivers/video/tegra/nvmap/nvmap_pp.c b/nvidia-oot/drivers/video/tegra/nvmap/nvmap_pp.c
index 1234567..abcdefg 100644
--- a/nvidia-oot/drivers/video/tegra/nvmap/nvmap_pp.c
+++ b/nvidia-oot/drivers/video/tegra/nvmap/nvmap_pp.c
@@ -13,6 +13,7 @@
 #include <linux/highmem.h>
 #include <linux/mm.h>
 #include <linux/mmzone.h>
+#include <linux/version.h>
 #include <linux/shrinker.h>
 #include <linux/slab.h>
 #include <linux/vmalloc.h>
@@ -790,7 +791,14 @@ int nvmap_page_pool_init(struct nvmap_device *dev)
 	pool->shrinker.count_objects = nvmap_page_pool_count_objects;
 	pool->shrinker.scan_objects = nvmap_page_pool_scan_objects;
 	pool->shrinker.seeks = DEFAULT_SEEKS;
+	
+#if LINUX_VERSION_CODE >= KERNEL_VERSION(6,6,0)
+	if (register_shrinker(&pool->shrinker, "nvmap_page_pool") != 0)
+		goto fail;
+#else
 	register_shrinker(&pool->shrinker);
+#endif
+
 
 	dev->pool = pool;
 
-- 
2.34.1